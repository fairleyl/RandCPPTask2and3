library("Rcpp")
library("devtools")
install_gitlab("fairleyl/stableMarriageR")
library(stableMarriage)

#Example usage. Preference tables are represented as named lists of string vectors
a = "a"
b = "b"
c = "c"
d = "d"
e = "e"
A = "A"
B = "B"
C = "C"
D = "D"
E = "E"

pref1 = list(
  A = c(a,b,c,d,e),
  B = c(b,c,d,e,a),
  C = c(c,d,e,a,b),
  D = c(d,e,a,b,c),
  E = c(e,a,b,c,d)
)

pref2 = list(
  a = c(B,C,D,E,A),
  b = c(C,D,E,A,B),
  c = c(D,E,A,B,C),
  d = c(E,A,B,C,D),
  e = c(A,B,C,D,E)
)

#raw c++ function
stableMatching(pref1, pref2)

#checking function for R
isValidPrefTables(pref1, pref2)

#R wrapper function
findStableMatching(pref1, pref2, checkTables = T)

#Generate preference tables
randomPrefTable = function(men, women)
{
  n = length(men)
  menPrefs = list()
  womenPrefs = list()
  
  for(man in men)
  {
    menPrefs[[man]] = sample(women, n)
  }
  
  for(woman in women)
  {
    womenPrefs[[woman]] = sample(men, n)
  }
  return(list("menPrefs" = menPrefs, "womenPrefs" = womenPrefs))
}

#Produce graph similar to python graph
set.seed(12345)
avgTimes = c()
maxN = 200
numReps = 30
nRange = 2:(maxN + 1)

for(n in nRange)
{
  men = as.character(1:n)
  women = as.character((n+1):(2*n))
  
  runningTime = 0
  for(i in 1:numReps)
  {
    problem = randomPrefTable(men, women)
    pref1 = problem[[1]]
    pref2 = problem[[2]]
    start = proc.time()
    findStableMatching(pref1, pref2)
    end = proc.time()
    runningTime = runningTime + (end - start)[3]
  }
  avg = runningTime/numReps
  avgTimes = c(avgTimes, avg)
  print(n)
}

#times imported from jupyter-lab, re-run on the virtual desktop for consistency
pythonTimes = c(9.336757163206736e-06,
                1.0704776893059412e-05,
                1.5677418559789658e-05,
                2.0799009750286738e-05,
                2.583274617791176e-05,
                4.0209634850422544e-05,
                4.520618046323459e-05,
                5.42805219690005e-05,
                5.563441663980484e-05,
                8.425181731581688e-05,
                0.00010516929129759471,
                9.631688396135965e-05,
                0.00010656636829177538,
                0.00015221539263923962,
                0.0001554057312508424,
                0.0001851338893175125,
                0.0001803891733288765,
                0.00019857656831542652,
                0.00021399250254034997,
                0.0002319153087834517,
                0.00026060811554392177,
                0.00025754238789280255,
                0.0003003422481318315,
                0.0003336719237267971,
                0.0003630686861773332,
                0.00035665761679410936,
                0.00039728032425045967,
                0.0004297741378347079,
                0.0005175947211682796,
                0.00045940419659018517,
                0.0004991180263459683,
                0.0005372786583999793,
                0.0005715103819966316,
                0.0005588105879724026,
                0.0006292941359182199,
                0.0006665683351457119,
                0.0007140800977746645,
                0.0007717092831929525,
                0.0007856184306244056,
                0.0008067805630465348,
                0.0007742811615268389,
                0.0009776649065315723,
                0.000948052170375983,
                0.0010361880995333195,
                0.0010252185786763827,
                0.0009739638616641362,
                0.0010827592574059962,
                0.0012366315349936485,
                0.0012716629542410373,
                0.0013082961551845074,
                0.00136533472687006,
                0.0014486094936728478,
                0.0013128744748731455,
                0.0014908407193919024,
                0.0015833487113316854,
                0.001539834588766098,
                0.0016905088598529498,
                0.0016122548220058282,
                0.0017809912251929442,
                0.0018852637459834418,
                0.0018349345152576765,
                0.0019574698060750963,
                0.0020617921526233356,
                0.0021359001286327837,
                0.002160436442742745,
                0.0022478746871153516,
                0.002319911029189825,
                0.002312518966694673,
                0.0025442772234479587,
                0.002684053344031175,
                0.0025187827336291472,
                0.0026754549083610377,
                0.002808302578826745,
                0.0027424505290885768,
                0.0029682269940773647,
                0.0030242475370566052,
                0.002923795146246751,
                0.00312931506584088,
                0.003203465820600589,
                0.0031781085456411046,
                0.0032629798476894695,
                0.002996310374389092,
                0.0032078176115949947,
                0.0033141635979215306,
                0.0036120265411833923,
                0.003618903364986181,
                0.0037556922684113185,
                0.00388472443446517,
                0.004075498630603154,
                0.0038744583415488403,
                0.004243334444860618,
                0.0042988604865968226,
                0.004320820172627767,
                0.004549811438967784,
                0.004704751912504435,
                0.0045786385734876,
                0.005197417456656694,
                0.004665534260372321,
                0.004931484473248323,
                0.00523769436404109,
                0.0052895740605890754,
                0.005212441769738992,
                0.005039318930357695,
                0.00585273935769995,
                0.005249017725388209,
                0.005371875905742248,
                0.005817055143415928,
                0.005719897740830978,
                0.005812924262136221,
                0.005964129976928234,
                0.006417001876980066,
                0.006185802910476923,
                0.006322122613588969,
                0.006333009991794825,
                0.006072967406362295,
                0.006829989608377218,
                0.00712118245040377,
                0.007313029871632655,
                0.006783631630241871,
                0.00720111196860671,
                0.007384044335534175,
                0.008009594057997067,
                0.007614847800383965,
                0.007237282705803713,
                0.008151040381441514,
                0.007408380632599195,
                0.008545965763429801,
                0.008695422920087974,
                0.007781060909231504,
                0.008518985006958246,
                0.008789568891127903,
                0.00824141421665748,
                0.00887491690615813,
                0.008355634473264217,
                0.00967256361618638,
                0.008796177556117375,
                0.009502680444469055,
                0.00937080302586158,
                0.00950919675330321,
                0.009673725254833699,
                0.010168532840907574,
                0.010687191132456064,
                0.010249722935259341,
                0.010109194368124009,
                0.010978954223295053,
                0.010411869827657938,
                0.010842949431389571,
                0.010735761901984612,
                0.010809584769109886,
                0.01116312937811017,
                0.010932414264728626,
                0.011278970756878455,
                0.011534054391086101,
                0.01172314810877045,
                0.012379570460567871,
                0.01242986371119817,
                0.013773699539403121,
                0.01285148827979962,
                0.012835284601897002,
                0.013453959425290426,
                0.013326031217972437,
                0.013351022421071926,
                0.013874967799832423,
                0.013693431268135707,
                0.014119314899047216,
                0.01495400747905175,
                0.014721501308182875,
                0.014261357113718986,
                0.014328564175715049,
                0.013887897475312154,
                0.014787118881940842,
                0.014889031648635864,
                0.014488919389744599,
                0.018029556858042875,
                0.0162170666269958,
                0.015680139294515054,
                0.016423937709381182,
                0.01684236035992702,
                0.015643722595026097,
                0.01699610874056816,
                0.016347864580651125,
                0.01675952486693859,
                0.0172728863855203,
                0.018830848050614198,
                0.01776094570135077,
                0.01652635938177506,
                0.01749528981745243,
                0.018094248510897158,
                0.01810807464644313,
                0.017999145574867724,
                0.018861559964716435,
                0.018231933129330476,
                0.018742994250108797,
                0.019877908968677124,
                0.019468486743668714,
                0.020132843653361,
                0.020698113677402336,
                0.020250724193950496,
                0.019479788343111672)

#Due to 0s and NAs, cut off some lower values (larger n are more important anyway)
logRange = log(nRange[log(nRange)>2.5])
logTimeR = log(avgTimes[log(nRange)>2.5])
logTimePy = log(pythonTimes[log(nRange)>2.5])

#Fit some linear models to check coefficients, *roughly* similar
modR = lm(logTimeR ~ logRange)
modPy = lm(logTimePy ~ logRange)

modR
modPy

#Generate overlapped log-log plots
minT = min(logTimePy, logTimeR, na.rm = T)
maxT = max(logTimePy, logTimeR, na.rm = T)
plot(logRange, logTimeR, type = "l", ylim = c(minT, maxT), xlab = "log(n)", ylab = "log(AvgTime(n))", main = "Performance of Code as n grows", col = "red")
lines(logRange, logTimePy, col = "blue")
legend(2.5,-4,
       legend = c("Rcpp","Python (jupyter-lab)"),
       col = c("red","blue"),
       lty = 1)

#Python's better (against wrapper function)!!!

#Produce similar graph to above using raw C++ function
set.seed(12345)
avgTimesNoWrap = c()
maxN = 200
numReps = 30
nRange = 2:(maxN + 1)

for(n in nRange)
{
  men = as.character(1:n)
  women = as.character((n+1):(2*n))
  
  runningTime = 0
  for(i in 1:numReps)
  {
    problem = randomPrefTable(men, women)
    pref1 = problem[[1]]
    pref2 = problem[[2]]
    start = proc.time()
    stableMatching(pref1, pref2)
    end = proc.time()
    runningTime = runningTime + (end - start)[3]
  }
  avg = runningTime/numReps
  avgTimesNoWrap = c(avgTimesNoWrap, avg)
  print(n)
}

logTimeC = log(avgTimesNoWrap[log(nRange)>2.5])
lines(logRange, logTimeC, col = "green")
legend(2.5,-4,
       legend = c("Rcpp (Wrapper)","Python (jupyter-lab)", "Rcpp (No Wrapper)"),
       col = c("red","blue","green"),
       lty = 1)
